---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: sealed-pihole-admin-password
  namespace: kube-system
spec:
  encryptedData:
    EXTERNAL_DNS_PIHOLE_PASSWORD: AgBcuAHQB8ykHsoPaL8cF/ZGqQIHFmKV+dvl/4GR/82JaHUFTh2hL7SXSgFSB3ZN47i5IQx1WUr+U/hJeXTAQ3cFPI90aOB+VVL+nUvZ9CCWOc4CKJwZ0utiQd5dD2lHxNismv76/Fsf/nyTDMitgAIZfzzMV7uBpKa1tyiG8Gk9hAxuXRc7C5U+ZIMDPJbz7unY8vxFjJGvJXfkWOSM+KoYKlpJOzgZuJX5HFNvOgXbfWvK8xmgeeVJZt1uwCgWgfE+P4iJwg9qoh5Ymuyan7oeU/suNh2EDxWziKMJwmz2GZ3deg4sJ4f5HsczVtEX3FIY5bPMr+SqVbJa52hKhJod/hkabZcYI6lrZksaeAMCmzC+8+NOAa5OYYjOw7iroNXX78Cl+ryIZkO8+8bcB/PLjp0R0/WCef4dlS5WuQQU3UR8sTgN/grU2PoPauDB0ldiyJsdlCtvqRinCPDSJnJ1afF6Qov8bfR8A7B8UblZ2h1N4/zLZuVdQkRPvfE+nzwaNZJk+yCCgD4LAPGJIBAb/36sLh82hPRnEZrUwUMhf4dPFalnEQ2iwBRtEDYsZmskEQCU45hUEuKsyJhrC40Ll9oFflLrV2gVN0KoiFdMLDme/SG6fLlIpiUHSC6aOLYof8L9t3SYIRPjmq25Sa18LamDddz3FWA2R8rGKeR6w3EN0GEojmaSozZ7y4hSxnw7Km9FtLdrtpM=
  template:
    metadata:
      creationTimestamp: null
      name: sealed-pihole-admin-password
      namespace: kube-system

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-dns
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns
rules:
- apiGroups: [""]
  resources: ["services","endpoints","pods", "namespaces"]
  verbs: ["get","watch","list"]
- apiGroups: ["extensions","networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get","watch","list"]
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["list","watch"]
- apiGroups: ["gateway.networking.k8s.io"]
  resources: ["gateways", "httproutes", "grpcroutes", "tlsroutes", "tcproutes", "udproutes"]
  verbs: ["get", "watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns-viewer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns
subjects:
- kind: ServiceAccount
  name: external-dns
  namespace: kube-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns
  namespace: kube-system
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: external-dns
  template:
    metadata:
      labels:
        app: external-dns
    spec:
      serviceAccountName: external-dns
      containers:
      - name: external-dns
        image: registry.k8s.io/external-dns/external-dns:v0.17.0
        # If authentication is disabled and/or you didn't create
        # a secret, you can remove this block.
        envFrom:
        - secretRef:
            # Change this if you gave the secret a different name
            name: sealed-pihole-admin-password
        args:
        - --source=service
        - --source=ingress
        - --source=gateway-grpcroute
        - --source=gateway-httproute
        - --source=gateway-tcproute
        - --source=gateway-tlsroute
        - --source=gateway-udproute
        # Pihole only supports A/AAAA/CNAME records so there is no mechanism to track ownership.
        # You don't need to set this flag, but if you leave it unset, you will receive warning
        # logs when ExternalDNS attempts to create TXT records.
        - --registry=noop
        # IMPORTANT: If you have records that you manage manually in Pi-hole, set
        # the policy to upsert-only so they do not get deleted.
        - --policy=upsert-only
        - --provider=pihole
        # Switch to pihole V6 API
        - --pihole-api-version=6
        # Change this to the actual address of your Pi-hole web server
        - --pihole-server=http://pihole.home.lan
        - --pihole-tls-skip-verify
        #
        - --log-level=debug
      securityContext:
        fsGroup: 65534 # For ExternalDNS to be able to read Kubernetes token files
